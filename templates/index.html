<!DOCTYPE html>
<html>
<head>
    <title>LLM Chat Interface</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
        }
        #conversation {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            background-color: #f0f0f0;
        }
        .bubble {
            max-width: 70%;
            padding: 10px;
            margin: 5px 0;
            border-radius: 15px;
            clear: both;
        }
        .user {
            background-color: #DCF8C6;
            align-self: flex-start;
            margin-left: auto;
        }
        .bot {
            background-color: #FFFFFF;
            align-self: flex-end;
            margin-right: auto;
        }
        #input-area {
            display: flex;
            padding: 10px;
            background: #ddd;
        }
        #messageInput {
            flex: 1;
            padding: 10px;
            font-size: 16px;
        }
        #sendBtn {
            padding: 10px 20px;
            font-size: 16px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div>
        <label for="modelSelect">Select Model:</label>
        <select id="modelSelect"></select>
    </div>
    <div id="conversation"></div>
    <div id="input-area">
        <textarea id="messageInput" rows="3" placeholder="Type your message..."></textarea>
        <button id="sendBtn" onclick="sendMessage()">Send</button>
    </div>



    <script>
        let conversationId = Date.now().toString();
        let currentModel = '';
        let conversations = {};

        const messageInput = document.getElementById('messageInput');

        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                if (e.altKey) {
                    // Insert newline at cursor position
                    e.preventDefault();
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    this.value = this.value.substring(0, start) + '\n' + this.value.substring(end);
                    this.selectionStart = this.selectionEnd = start + 1;
                } else if (e.shiftKey) {
                    // Allow Shift+Enter to insert newline
                    // Do nothing, default behavior
                } else {
                    // Send message on Enter
                    e.preventDefault();
                    sendMessage();
                }
            }
        });


        // Load models and conversation
        async function loadModels() {
            const res = await fetch('/settings');
            const settings = await res.json();
            currentModel = settings.model;

            // Fetch model keys
            const modelRes = await fetch('/model_keys');
            const modelKeys = await modelRes.json();

            const select = document.getElementById('modelSelect');
            select.innerHTML = '';
            for (const model of Object.keys(modelKeys)) {
                const option = document.createElement('option');
                option.value = model;
                option.text = model;
                if (model === currentModel) {
                    option.selected = true;
                }
                select.appendChild(option);
            }

            select.onchange = () => {
                currentModel = select.value;
                saveModelSetting();
                // Reset conversation if needed
                conversationId = Date.now().toString();
                conversations[conversationId] = [];
                displayConversation();
            };
        }

        async function saveModelSetting() {
            await fetch('/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({model: currentModel})
            });
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;

            if (!conversations[conversationId]) {
                conversations[conversationId] = [];
            }

            // Add user message
            conversations[conversationId].push({role: 'user', content: message});
            displayConversation();

            // Send to backend
            const res = await fetch('/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    conversation_id: conversationId,
                    message: message,
                    model: currentModel
                })
            });
            const data = await res.json();

            // Add bot response
            conversations[conversationId].push({role: 'assistant', content: data.response});
            displayConversation();

            input.value = '';
        }

        function displayConversation() {
            const container = document.getElementById('conversation');
            container.innerHTML = '';

            if (!conversations[conversationId]) return;

            conversations[conversationId].forEach(entry => {
                const bubble = document.createElement('div');
                bubble.className = 'bubble ' + (entry.role === 'user' ? 'user' : 'bot');
                bubble.innerText = entry.content;
                container.appendChild(bubble);
            });

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        // Initialize
        window.onload = () => {
            loadModels();
        };
    </script>
</body>
</html>
